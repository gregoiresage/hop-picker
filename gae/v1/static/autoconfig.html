<!DOCTYPE html>
<html>
<head>
	<title>HopPicker</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.1/jquery.mobile-1.4.1.min.css">
	<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.1/jquery.mobile-1.4.1.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
	<style type="text/css">
	
	</style>
</head>

<body>
	<div data-role="page" id="configuration">
		<div data-role="header" id="header">
			<button id="b-cancel" data-icon="delete" data-iconpos="left" data-inline="true" data-mini="true">Cancel</button>
			<h1>HopPicker</h1>
		</div>
		<div role="main" class="ui-content">
			<form id="configuration-form">
				
				<div class="ui-field-contain">
					<label for="color">Black & White</label>
					<input type="checkbox" data-role="flipswitch" name="color" id="color" data-on-text="ON" data-off-text="OFF" data-wrapper-class="color-size-flipswitch">
				</div>
				<div class="ui-field-contain">
					<label for="inverted">Inverted</label>
					<input type="checkbox" data-role="flipswitch" name="inverted" id="inverted" data-on-text="ON" data-off-text="OFF" data-wrapper-class="inverted-size-flipswitch">
				</div>
				<div class="ui-field-contain">
					<label for="date">Display the date</label>
					<input type="checkbox" data-role="flipswitch" name="date" id="date" data-on-text="ON" data-off-text="OFF" data-wrapper-class="date-size-flipswitch">
				</div>
				<div class="ui-field-contain">
					<label for="hand">Choose the hand</label>
					<select name="hand" id="hand">
						<option value="0">LINE</option>
						<option value="1">ARROW</option>
					</select>
				</div>
				<div class="ui-field-contain">
					<label for="calendar">Display the next calendar event</label>
					<input type="checkbox" data-role="flipswitch" name="calendar" id="calendar" data-on-text="ON" data-off-text="OFF" data-wrapper-class="calendar-size-flipswitch">
				</div>
				<button data-theme="a" id="btn-login">Log in</button>
				<div class="ui-field-contain">
					<!-- <label for="access_token">access_token</label> -->
					<input type="hidden" name="access_token" id="access_token" value="" maxlength="116" data-clear-btn="true">
				</div>
				<div class="ui-field-contain">
					<!-- <label for="refresh_token">refresh_token</label> -->
					<input type="hidden" name="refresh_token" id="refresh_token" value="" maxlength="116" data-clear-btn="true">
				</div>
				
				<button id="b-submit" data-theme="b" data-icon="check" data-iconpos="right">Save</button>
			</form>
		</div>
		<div data-role="footer" id="footer" data-position="fixed">
			<h2>Powered by Pebble Autoconfig</h2>
		</div>
	</div>
	<script type="text/javascript">	 
	// this.getUrlParams = function () {
	// 	var params = {};
	// 	var bits = window.location.href.replace(/[?&#]+([^=&]+)=([^&]*)/g, function (match, key, value) {
	// 		params[key] = value;
	// 	});
	// 	log("URL parameters: " + JSON.stringify(params, null, 1));
	// 	return params;
	// };

			var opts = {}
			function updateControls() {
				console.log("updateControls");
				console.log(window.location.hash.substring(1));
				// try {
				// 	opts = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
				// } catch(e) {
				// 	console.log(e);
				// }
				var bits = window.location.href.replace(/[?&#]+([^=&]+)=([^&]*)/g, function (match, key, value) {
					opts[key] = value;
				});
				console.log(opts);
				if(opts.access_token){
					$("#access_token").val(opts.access_token);
				}
				if(opts.refresh_token){
					$("#refresh_token").val(opts.refresh_token);
				}
				if(opts.access_token) { // TODO: check token validity
			//		$("#btn-login").hide();
				} else {
			//		$("#btn-logout").hide();
				}
			}

		$().ready(function() {	  
			var dictionary;
			try {
				dictionary = JSON.parse(localStorage['HopPicker']);
			} catch(e) {
				dictionary = {};
			}
			
			
			if(!dictionary.hasOwnProperty('color')) {
				dictionary['color'] = false;
			}
			$('#color').prop('checked', (dictionary['color'])).flipswitch( "refresh" );
			if(!dictionary.hasOwnProperty('inverted')) {
				dictionary['inverted'] = false;
			}
			$('#inverted').prop('checked', (dictionary['inverted'])).flipswitch( "refresh" );
			if(!dictionary.hasOwnProperty('date')) {
				dictionary['date'] = false;
			}
			$('#date').prop('checked', (dictionary['date'])).flipswitch( "refresh" );
			if(!dictionary.hasOwnProperty('hand')) {
				dictionary['hand'] = '0';
			}
			$('#hand').val(dictionary['hand'].toString()).selectmenu('refresh');
			if(!dictionary.hasOwnProperty('calendar')) {
				dictionary['calendar'] = false;
			}
			$('#calendar').prop('checked', (dictionary['calendar'])).flipswitch( "refresh" );
			if(!dictionary.hasOwnProperty('access_token')) {
				dictionary['access_token'] = '';
			}
			$('#access_token').val(dictionary['access_token']);
			// $.validator.addMethod("access_token", function(value, element) {
			// 	return this.optional(element) ;
			// }, "Text field is invalid.");
			if(!dictionary.hasOwnProperty('refresh_token')) {
				dictionary['refresh_token'] = '';
			}
			$('#refresh_token').val(dictionary['refresh_token']);
			// $.validator.addMethod("refresh_token", function(value, element) {
			// 	return this.optional(element) ;
			// }, "Text field is invalid.");

			updateControls();
		});
		
		// Handle different UI on i-devices
		if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ) {
			$("#header").remove();
		}
		
		$("form :input").on("keypress", function(e) {
			return e.keyCode != 13;
		});
		
		$("#configuration-form").validate({
			rules: {
				
				access_token: "required access_token",
				
				refresh_token: "required refresh_token",
				
				
			},
			errorPlacement: function(error, element) {
				error.insertAfter( element.parent() );
			}
		});

		/** Log into Google account
			 */
			function doLogin() {
				window.location = "auth?" + $.param({
						response_type: "code",
						scope: "https://www.googleapis.com/auth/calendar.readonly",
						state: "",
						access_type: "offline",
						approval_prompt: "force", // If user tries to authenticate then we have no valid refresh tokens.
						include_granted_scopes: "true",
				});
			}

			function saveOptions(){
				var dictionary = {};
			
			dictionary['color'] = ($('#color').prop('checked') ? 1 : 0);
			dictionary['inverted'] = ($('#inverted').prop('checked') ? 1 : 0);
			dictionary['date'] = ($('#date').prop('checked') ? 1 : 0);
			dictionary['hand'] = parseInt($('#hand').val());
			dictionary['calendar'] = ($('#calendar').prop('checked') ? 1 : 0);
			dictionary['access_token'] = $('#access_token').val();
			dictionary['refresh_token'] = $('#refresh_token').val();
			
			localStorage['HopPicker'] = JSON.stringify(dictionary);
			}

		$('#b-submit').click(function() {
			if (!$("#configuration-form").valid()) {
				return false;
			}
			
			saveOptions();

			var location = "pebblejs://close#" + encodeURIComponent(localStorage['HopPicker']);
			window.location.href = location;
		});
	
		$('#b-cancel').click(function() {
			var location = "pebblejs://close#";
			window.location.href = location;
		});

		$('#btn-login').click(function() {
			doLogin();
		});
	</script>
</body>
</html>